<!DOCTYPE html>
<html>
<title>Osobni podaci</title>

<meta charset="UTF-8" name="viewport"
	content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="http://www.w3schools.com/lib/w3.css">
<link rel="stylesheet"
	href="https://fonts.googleapis.com/css?family=Raleway">
<link rel="stylesheet"
	href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<link href="https://fonts.googleapis.com/icon?family=Material+Icons"
	rel="stylesheet">

<!-- Jquery -->
<script
	src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
<script src="js/general.js"></script>
<script src="js/htmlescaping.js"></script>

<style>
html, body, h1, h2, h3, h4, h5 {
	font-family: "Raleway", sans-serif
}
</style>

<script type="text/javascript">
	$(document).ready(function() {
		var register = sessionStorage.getItem('register');
		
		if (isEmpty(register)) {
			openModal('modal1', 'Nemate ovlasti biti na ovoj stranici.');
		} else {
			var username = sessionStorage.getItem('username');
			$("input[name='username']").val(username);
			
			if (register == 'true') {
				var password = sessionStorage.getItem('password');
				$("input[name='password']").val(password);
				$('#formButton').html('Završi registraciju');
			} else {
				$.ajax({
					type : 'GET',
					url : "service/users/username/"
							+ username,
					dataType : 'json',
					success : function(responseData, textStatus, jqXHR) {
						var user = responseData;
						sessionStorage.setItem('user', JSON.stringify(user));
						$("input[name='firstName']").val(user.firstName);
						$("input[name='lastName']").val(user.lastName);
						$("input[name='email']").val(user.email);
						
						$("input[name='oib']").val(user.oib);
						$("input[name='telefon']").val(user.telefon);
						$("input[name='town']").val(user.address.town);
						$("input[name='dateOfBirth']").val(user.dateOfBirth);
						if (user.address.postCode != 0){
							$("input[name='postCode']").val(user.address.postCode);
						}
						$("input[name='street']").val(user.address.street);
						if (user.address.houseNumber != 0){
							$("input[name='houseNumber']").val(user.address.houseNumber);
						}
						
						$('#formButton').html('Spremi promjene');
						$('#usernameDiv').show();
						$('#passwordDiv').show();
					},
					error : function(responseData, textStatus, errorThrown) {
						alert('GET failed.');
					}
				});
			}
		}
	});
</script>

<script type="text/javascript">
	function createRemoteUser() {
		var username = $(" input[name='username'] ").val();
		var firstName = $("input[name='firstName']").val();
		var lastName = $("input[name='lastName']").val();
		var email = $("input[name='email']").val();
	
		if (sessionStorage.getItem('register') == 'true'){
			var remoteUser = {
					username : username,
					firstName : firstName,
					lastName : lastName,
					email : email
			};
			return remoteUser;
		} else {
			var user = JSON.parse(sessionStorage.getItem('user'));
			var editedUser = {
					id: user.id,
					username : username,
					firstName : firstName,
					lastName : lastName,
					email : email
			}
			return editedUser;
		}

		return remoteUser;
	}

	function createLocalUser() {
		var username = $(" input[name='username'] ").val();
		var password = $("input[name='password']").val()
		var firstName = $("input[name='firstName']").val();
		var lastName = $("input[name='lastName']").val();
		var telefon = $("input[name='telefon']").val();
		var email = $("input[name='email']").val();
		var oib = $("input[name='oib']").val();
		var dateOfBirth = $("input[name='dateOfBirth']").val();
		var town = $("input[name='town']").val();
		var postCode = $("input[name='postCode']").val();
		var street = $("input[name='street']").val();
		var houseNumber = $("input[name='houseNumber']").val();

		var address = {
				town : town,
				postCode : postCode,
				street : street,
				houseNumber : houseNumber
		}
		
		if (sessionStorage.getItem('register') == 'true'){
			var user = {
				username : username,
				password : password,
				firstName : firstName,
				lastName : lastName,
				oib : oib,
				dateOfBirth : dateOfBirth,
				address : address,
				email : email
			}

			return user;
		} else {
			var user = JSON.parse(sessionStorage.getItem('user'));
			var editedUser = {
					id: user.id,
					username : username,
					password : password,
					firstName : firstName,
					lastName : lastName,
					oib : oib,
					dateOfBirth : dateOfBirth,
					address : address,
					email : email	
			}
			return editedUser;
		}
	}

	function persistUserToRemote() {
		var remoteUser = createRemoteUser();

		//contentType ono kaj se salje
		//dataType ono kaj dobijem nazad ako primam text/plain ostavit prazno
		$.ajax({
			type : 'POST',
			url : "http://localhost:8080/baza-podataka/service/users",
			crossDomain : true,
			data : JSON.stringify(remoteUser),
			contentType : "application/json",
			dataType : 'text',
			success : function(responseData, textStatus, jqXHR) {
				sessionStorage.removeItem('password');
				sessionStorage.removeItem('register');
				sessionStorage.removeItem('user');
				sessionStorage.setItem('username', remoteUser.username);
				changeWindowUrl('home.html');
			},
			error : function(responseData, textStatus, errorThrown) {
				alert('POST remote failed.' + textStatus + errorThrown);
			}
		});

	}

	function persistUserToLocal() {
		var localUser = createLocalUser();

		$.ajax({
			type : 'POST',
			url : "service/users",
			data : JSON.stringify(localUser),
			contentType : "application/json",
			dataType : 'text',
			success : function(responseData, textStatus, jqXHR) {
				persistUserToRemote();
			},
			error : function(responseData, textStatus, errorThrown) {
				alert('POST local failed.' + textStatus + errorThrown);
			}
		});
	}
	
	function checkIfEmailExists(){
		var email = $("input[name='email']").val();

		$.ajax({
			type : 'GET',
			url : "http://localhost:8080/baza-podataka/service/users/exists/email/"
					+ email,
			crossDomain : true,
			dataType : 'text',
			success : function(responseData, textStatus, jqXHR) {
				var emailExists = responseData;
				if (emailExists == "true") {
					openModal('modal2', 'Upisani email već postoji. Unesite drugi');
				} else {
					persistUserToLocal();
				}
			},
			error : function(responseData, textStatus, errorThrown) {
				alert('GET failed.');
			}
		});

	}

	function validateForm() {
		if (emptyExists('requiredInput')) {
			return;
		}
		var dateOfBirth = $("input[name='dateOfBirth']").val();
		if (!isValidDate(dateOfBirth)) {
			openModal(
					'modal2',
					'Upisali ste datum rođenja u krivom formatu. <p>Potrebno ga je zapisat u formatu mm/dd/yyyy<p>Vaš datum: '
					+ htmlEscape(dateOfBirth));
		}
		if (sessionStorage.getItem('register') == 'true') {
			checkIfEmailExists();
		} else {
			var user = JSON.parse(sessionStorage.getItem('user'));
			var newUsername = $(" input[name='username'] ").val();
			if (user.username != newUsername) {
				$
						.ajax({
							type : 'GET',
							url : "http://localhost:8080/baza-podataka/service/users/exists/username/"
									+ newUsername,
							crossDomain : true,
							dataType : 'text',
							success : function(responseData, textStatus, jqXHR) {
								var exists = responseData;
								if (exists == "true") {
									openModal('modal2',
											"Korisnicko ime postoji, izaberite drugo!");
								} else {
									var newEmail = $(" input[name='email'] ")
											.val();
									if (newEmail != user.email) {
										checkIfEmailExists();
									} else {
										persistUserToLocal();
									}
								}
							},
							error : function(responseData, textStatus,
									errorThrown) {
								alert('GET failed.');
							}
						});
			} else {
				var newEmail = $(" input[name='email'] ").val();
				if (newEmail != user.email) {
					checkIfEmailExists();
				} else {
					persistUserToLocal();
				}
			}
		}
	}
</script>
<body class="w3-white">

	<h1 class='w3-center' id='title'>Troškovnik života</h1>

	<form action='javascript:void(0);' id=''
		class="w3-container w3-card-4 w3-light-grey w3-text-blue w3-margin"
		style="width: 60%; position: relative; left: 20%;">

		<h2 class="w3-center">Unos osobnih podataka</h2>

		<div class="w3-row w3-section" id="usernameDiv" style="display: none;">
			<div class="w3-col" style="width: 50px;">
				<i class="w3-xxlarge fa fa-user"></i>
			</div>
			<div class="w3-rest">
				<input class="requiredInput w3-input w3-border w3-round"
					name="username" type="text" required placeholder="Korisnicko ime *">
			</div>
		</div>

		<div class="w3-row w3-section" id="passwordDiv" style="display: none;">
			<div class="w3-col" style="width: 50px">
				<i class="w3-xxlarge fa fa-shield"></i>
			</div>
			<div class="w3-rest">
				<input class="requiredInput w3-input w3-border  w3-round"
					name="password" type="text" required placeholder="Nova sifra *">
			</div>
		</div>

		<div class="w3-row w3-section">
			<div class="w3-col" style="width: 50px">
				<i class="w3-xxlarge fa fa-user"></i>
			</div>
			<div class="w3-rest">
				<input class="requiredInput w3-input w3-border w3-round"
					name="firstName" type="text" required placeholder="Ime *">
			</div>
		</div>

		<div class="w3-row w3-section">
			<div class="w3-col" style="width: 50px">
				<i class="w3-xxlarge fa fa-user"></i>
			</div>
			<div class="w3-rest">
				<input class="requiredInput w3-input w3-border w3-round"
					name="lastName" type="text" required placeholder="Prezime *">
			</div>
		</div>

		<div class="w3-row w3-section">
			<div class="w3-col" style="width: 50px">
				<i class="w3-xxlarge fa fa-phone"></i>
			</div>
			<div class="w3-rest">
				<input class="w3-input w3-border w3-animate-input" name="telefon"
					type="text" placeholder="Telefonski broj">
			</div>
		</div>

		<div class="w3-row w3-section">
			<div class="w3-col" style="width: 50px">
				<i class="w3-xxlarge fa fa-envelope-o"></i>
			</div>
			<div class="w3-rest">
				<input class="requiredInput w3-input w3-border w3-round"
					name="email" type="text" placeholder="Email">
			</div>
		</div>

		<div class="w3-row w3-section">
			<div class="w3-col" style="width: 50px">
				<i class="w3-xxlarge fa fa-id-card-o"></i>
			</div>
			<div class="w3-rest">
				<input class="w3-input w3-border w3-round" name="oib" type="text"
					placeholder="OIB">
			</div>
		</div>


		<div class="w3-row w3-section">
			<div class="w3-col" style="width: 50px">
				<i class="w3-xxlarge fa fa-birthday-cake"></i>
			</div>
			<div class="w3-rest">
				<input class="w3-input w3-border w3-round" name="dateOfBirth"
					type="text" placeholder="Datum rođenja, oblika mm/dd/yyyy">
			</div>
		</div>

		<div class="w3-row w3-section">
			<div class="w3-col" style="width: 50px">
				<i class="material-icons" style="font-size: 40px">location_city</i>
			</div>
			<div class="w3-rest">
				<input class="w3-input w3-border w3-round" name="town" type="text"
					placeholder="Naziv mjesta">
			</div>
		</div>

		<div class="w3-row w3-section">
			<div class="w3-col" style="width: 50px">
				<i class="material-icons" style="font-size: 40px">location_city</i>
			</div>
			<div class="w3-rest">
				<input class="w3-input w3-border w3-round" name="postcode"
					type="text" placeholder="Poštanski broj">
			</div>
		</div>

		<div class="w3-row-padding">
			<div class="w3-half w3-row w3-section">
				<div class="w3-col" style="width: 50px">
					<i class="w3-xxlarge fa fa-building-o"></i>
				</div>
				<div class="w3-rest">
					<input class="w3-input w3-border w3-round" name="street"
						type="text" placeholder="Ulica">
				</div>
			</div>
			<div class="w3-half w3-row w3-section">
				<div class="w3-col" style="width: 50px">
					<i class="w3-xxlarge fa fa-envelope-o"></i>
				</div>
				<div class="w3-rest">
					<input class="w3-input w3-border  w3-round" name="houseNumber"
						type="text" placeholder="Kućni Broj">
				</div>
			</div>
		</div>

		<button class="w3-btn-block w3-section w3-blue w3-ripple w3-padding"
			onclick="validateForm()" id='formButton'></button>

	</form>

	<div id="modal1" class="w3-modal">
		<div class="w3-modal-content w3-card-4 w3-animate-zoom">
			<header class="w3-container w3-red">
				<span onclick="$('#modal1').hide(); changeWindowUrl('index.html')"
					class="w3-closebtn w3-padding-top">&times;</span>
				<h2>
					Greška <i class="w3-xxlarge fa fa-exclamation-circle"></i>
				</h2>
			</header>
			<div class="w3-container">
				<h4 class="textHolder"></h4>
			</div>
			<div class="w3-container w3-light-grey w3-padding">
				<button class="w3-btn w3-right w3-white w3-border"
					onclick="$('#modal1').hide(); changeWindowUrl('index.html')">Zatvori</button>
			</div>
		</div>
	</div>

	<div id="modal2" class="w3-modal">
		<div class="w3-modal-content w3-card-4 w3-animate-zoom">
			<header class="w3-container w3-red">
				<span onclick="$('#modal2').hide()"
					class="w3-closebtn w3-padding-top">&times;</span>
				<h2>
					Greška <i class="w3-xxlarge fa fa-exclamation-circle"></i>
				</h2>
			</header>
			<div class="w3-container">
				<h4 class="textHolder"></h4>
			</div>
			<div class="w3-container w3-light-grey w3-padding">
				<button class="w3-btn w3-right w3-white w3-border"
					onclick="$('#modal2').hide()">Zatvori</button>
			</div>
		</div>
	</div>
</body>
</html>